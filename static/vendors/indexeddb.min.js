"use strict";!function(){var a=angular.module("angularIndexedDb",[]);a.factory("angularIndexedDb",["$q","$rootScope",function(a,b){b.$safeApply||(b.$safeApply=function(a){var b=this.$root.$$phase;"$apply"==b||"$digest"==b?a&&a():this.$apply(a)});var c=function(a){return function(c){b.$safeApply(function(){a.resolve(c.target.result)})}},d=function(a){return function(c){b.$safeApply(function(){a.reject(c.target.error)})}},e=function(a){this._index=a,this.name=a.name,this.objectStore=a.objectStore,this.keyPath=a.keyPath,this.multiEntry=a.multiEntry,this.unique=a.unique};e.prototype.openCursor=function(a,b){b=b||"next";var c={then:function(a,b){a&&(this._successHandler=a),b&&(this._errorHandler=b)},_successHandler:function(){},_errorHandler:function(){}},d=this._index.openCursor(a,b);return d.onsuccess=function(){c._successHandler(d.result)},d.onerror=function(){c._errorHandler(d.error)},c},e.prototype.openKeyCursor=function(a,b){b=b||"next";var c={then:function(a,b){a&&(this._successHandler=a),b&&(this._errorHandler=b)},_successHandler:function(){},_errorHandler:function(){}},d=this._index.openKeyCursor(a,b);return d.onsuccess=function(){c._successHandler(d.result)},d.onerror=function(){c._errorHandler(d.error)},c},e.prototype.get=function(b){var e=a.defer(),f=this._index.get(b);return f.onsuccess=c(e),f.onerror=d(e),e.promise},e.prototype.getKey=function(b){var e=a.defer(),f=this._index.getKey(b);return f.onsuccess=c(e),f.onerror=d(e),e.promise},e.prototype.count=function(b){var e=a.defer(),f=this._index.count(b);return f.onsuccess=c(e),f.onerror=d(e),e.promise};var f=function(a){this._objectStore=a,this.name=a.name,this.keyPath=a.keyPath,this.indexNames=a.indexNames,this.transaction=a.transaction,this.autoIncrement=a.autoIncrement,this._indexCache={}};f.prototype.put=function(b,e){var f=a.defer(),g=this._objectStore.put(b,e);return g.onsuccess=c(f),g.onerror=d(f),f.promise},f.prototype.delete=function(b){var e=a.defer(),f=this._objectStore.delete(b);return f.onsuccess=c(e),f.onerror=d(e),e.promise},f.prototype.get=function(b){var e=a.defer(),f=this._objectStore.get(b);return f.onsuccess=c(e),f.onerror=d(e),e.promise},f.prototype.clear=function(){var b=a.defer(),e=this._objectStore.clear();return e.onsuccess=c(b),e.onerror=d(b),b.promise},f.prototype.openCursor=function(a,b){b=b||"next";var c={then:function(a,b){a&&(this._successHandler=a),b&&(this._errorHandler=b)},_successHandler:function(){},_errorHandler:function(){}},d=this._objectStore.openCursor(a,b);return d.onsuccess=function(){c._successHandler(d.result)},d.onerror=function(){c._errorHandler(d.error)},c},f.prototype.createIndex=function(a,b,c){var d=this._objectStore.createIndex(a,b,c);return new e(d)},f.prototype.index=function(a){return a in this._indexCache?this._indexCache[a]:this._indexCache[a]=new e(this._objectStore.index(a))},f.prototype.deleteIndex=function(a){this._objectStore.deleteIndex(a)},f.prototype.count=function(b){var e=a.defer(),f=this._objectStore.count(b);return f.onsuccess=c(e),f.onerror=d(e),e.promise};var g=function(a){this._transaction=a,this.db=a.db,this.mode=a.mode,this._objectStoreCache={}};g.prototype.error=function(){return this._transaction.error},g.prototype.objectStore=function(a){return a in this._objectStoreCache?this._objectStoreCache:this._objectStoreCache[a]=new f(this._transaction.objectStore(a))},g.prototype.abort=function(){this._transaction.abort(),this._objectStoreCache={}};var h=function(a){this._db=a,this.name=a.name,this.version=a.version,this.objectStoreNames=a.objectStoreNames};return h.prototype.createObjectStore=function(a,b){var c=this._db.createObjectStore(a,b);return new f(c)},h.prototype.deleteObjectStore=function(a){this._db.deleteObjectStore(a)},h.prototype.transaction=function(a,b){b=b||"readonly";var c=this._db.transaction(a,b);return new g(c)},h.prototype.close=function(){this._db.close()},{open:function(c,e,f){var g=a.defer(),i=window.indexedDB.open(c,e);return i.onsuccess=function(){b.$safeApply(function(){var a=new h(i.result);g.resolve(a)})},i.onerror=i.onblocked=d(g),i.onupgradeneeded=function(){f(new h(i.result))},g.promise},deleteDatabase:function(b){var e=a.defer(),f=window.indexedDB.deleteDatabase(b);return f.onsuccess=c(e),f.onerror=f.onblocked=d(e),e.promise},cmp:function(a,b){return window.indexedDB.cmp(a._db,b._db)}}}])}();